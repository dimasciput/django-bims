{% load static from staticfiles %}
{% load site %}
<link href="{% static "js/libs/openlayers-4.6.4/ol.css" %}"
      rel="stylesheet">
<link href="{% static "js/libs/ol-layerswitcher/ol3-layerswitcher.css" %}"
      rel="stylesheet">
<style>
    #form-map {
        width: 100%;
        height:  500px;
        padding-bottom: 20px;
    }
    .layer-switcher.shown .panel {
        padding-top: 15px;
    }
    .layer-switcher li.layer label, .layer-switcher li.layer input {
        vertical-align: bottom !important;
    }
</style>
<div id="form-map"></div>
<script src="{% static "js/libs/openlayers-4.6.4/ol.js" %}"></script>
<script src="{% static "js/libs/ol-layerswitcher/ol-layerswitcher.js" %}"></script>
<script>
    let map = null;
    const basemapLayers = {% basemap_layers %};
    const _locationSiteGeoserverLayer = '{{ bims_preferences.geoserver_location_site_layer }}';
    const _defaultWMSSiteParameters = '{{ preferences.SiteSetting.default_location_site_cluster }}';
    (function () {
        const getBaseMaps = () => {
            const baseMaps = [
                new ol.layer.Tile({
                    title: 'OSM',
                    type: 'base',
                    source: new ol.source.OSM(),
                    visible: false
                }),
            ];
            for (let i = 0; i < basemapLayers.length; i++) {
                const baseMapData = basemapLayers[i];
                let _baseMap = null;
                if (baseMapData['source_type'] === "xyz") {
                    _baseMap = new ol.layer.Tile({
                        title: baseMapData['title'],
                        source: new ol.source.XYZ({
                            attributions: [baseMapData['attributions']],
                            url: '/bims_proxy/' + baseMapData['url']
                        })
                    })
                } else if (baseMapData['source_type'] === "bing") {
                    _baseMap = new ol.layer.Tile({
                        title: baseMapData['title'],
                        source: new ol.source.BingMaps({
                            key: baseMapData['key'],
                            imagerySet: 'AerialWithLabels'
                        })
                    });
                } else if (baseMapData['source_type'] === "stamen") {
                    _baseMap = new ol.layer.Tile({
                        title: baseMapData['title'],
                        source: new ol.source.Stamen({
                            layer: baseMapData['layer_name']
                        })
                    });
                }
                if (_baseMap) {
                    _baseMap.set('visible', baseMapData['default_basemap']);
                    _baseMap.set('type', 'base');
                    _baseMap.set('preload', Infinity);
                    baseMaps.push(_baseMap);
                }
            }
            let options = {
                url: 'https://maps.kartoza.com/geoserver/wms',
                params: {
                    layers: 'kartoza:sa_rivers',
                    format: 'image/png'
                }
            };
            let riverLayer = new ol.layer.Tile({
                title: 'River',
                source: new ol.source.TileWMS(options),
                type: 'layer',
            });
            baseMaps.unshift(riverLayer)
            let biodiversityLayersOptions = {
                url: geoserverPublicUrl + 'wms',
                params: {
                    LAYERS: _locationSiteGeoserverLayer,
                    FORMAT: 'image/png8',
                    viewparams: 'where:' + _defaultWMSSiteParameters
                },
                ratio: 1,
                serverType: 'geoserver'
            };
            let biodiversitySource = new ol.source.ImageWMS(biodiversityLayersOptions);
            let biodiversityTileLayer = new ol.layer.Image({
                title: 'Sites',
                type: 'layer',
                source: biodiversitySource
            });
            baseMaps.unshift(biodiversityTileLayer);
            return baseMaps.reverse()
        }
        map = new ol.Map({
            target: 'form-map',
            layers: getBaseMaps(),
            view: new ol.View({
                center: [0, 0],
                zoom: 2,
            }),
        });
        const layerSwitcher = new LayerSwitcher();
        map.addControl(layerSwitcher);
    })();
</script>
