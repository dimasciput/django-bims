{% extends 'main_base.html' %}
{% load static from staticfiles %}
{% block subtitle %}
    Site visit list
{% endblock %}

{% block head %}

    <!-- Custom styles for this template -->
    <link rel="stylesheet"
          href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <link href="{% static "css/fish_form.css" %}" rel="stylesheet">
    <link href="{% static "css/dashboard_buttons.css" %}" rel="stylesheet">
    <style>
        .btn-sm {
            font-size: 10pt !important;
        }

        .pagination-centered {
            text-align: center;
        }

        ul.pagination {
            display: flex;
            align-items: center;
            list-style: none;
        }

        ul.pagination li {
            display: inline-block;
            margin-left: 1rem;
        }

        ul.pagination li.arrow {
            font-size: 2rem;
        }

        ul.pagination li a {
            margin-right: 1rem;
        }

        ul.pagination li.current a {
            font-weight: bold;
            background-color: #18A090 !important;
            border-radius: 3rem;
            padding: 0.3rem 0.8rem;
            color: #fff;
        }

        #sortable {
            list-style-type: none;
            margin: 0;
            padding: 0;
            padding-left: 15px;
            width: 100%;
        }

        #sortable li {
            margin: 3px 3px 3px 0;
            padding: 10px;
            width: 32%;
            height: 90px;
        }

        #sortable li .row {
            height: 100%;
        }

        #sortable li img {
            max-height: 80%;
            max-width: 100%;
            width: auto;
            height: auto;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            margin: auto;
        }

        .taxon-group-title {
            font-size: 1.5em;
        }

        ul li {
            display: inline-block;
            vertical-align: top;
        }

        .selected {
            border-color: #179f90;
            background-color: #179f9026;
        }

    </style>

{% endblock %}

{% block body_content %}
    <div class="body-form container">
        <div class="dashboard-title">
            <h2>Taxa management</h2>
            <div class="dashboard-close" data-destination="/map"><i
                    class="fa fa-times" aria-hidden="true"></i></div>
        </div>
        <div class="dashboard-body">
            <ul id="sortable">
                {% for taxa_group in taxa_groups %}
                    <li data-id="{{ taxa_group.id }}" class="ui-state-default">
                        <div class="row">
                            <div class="col-sm-3 img-container">
                                <img src="{{ taxa_group.logo.url }}"/>
                            </div>
                            <div class="col-sm-9">
                                <span class="taxon-group-title">
                                    {{ taxa_group.name }}
                                </span>
                            </div>
                        </div>
                    </li>
                {% endfor %}
            </ul>
            <hr style="max-width: 100% !important; border-color: #e6c762"/>
            <table class="table table-striped">
                <thead>
                <tr>
                    <th scope="col" style="width: 30%">Taxon Name</th>
                    <th scope="col" style="width: 20%">Rank</th>
                    <th scope="col">Taxonomic Status</th>
                </tr>
                </thead>
                <tbody id="taxa-list">

                </tbody>
            </table>
            <div class="pagination-centered" style="display:none">
                <ul class="pagination">
                    <li class="arrow"><a href="#" class="pagination pagination-previous">&laquo;</a></li>
                    <li class="current">
                        <span id="taxa-current-page"></span>  - <span id="taxa-current-size"></span> / <span id="taxa-count"></span>
                    </li>
                    <li class="arrow"><a href="#" class="pagination pagination-next">&raquo;</a></li>
                </ul>
            </div>

        </div>
    </div>
{% endblock %}

{% block foot %}

    <!-- Plugin JavaScript -->
    <script src="{% static "js/libs/jquery/jquery-3.3.1.min.js" %}"></script>
    <script src="{% static "js/libs/jquery-ui-1.12.1/jquery-ui.min.js" %}"></script>
    <script src="{% static "js/libs/bootstrap-4.0.0/js/bootstrap.min.js" %}"></script>

    <script>
        $("#sortable").sortable({
            stop: function (event, ui) {
                let $li = $(event.target).find('li');
                let ids = [];
                $.each($li, function (index, element) {
                    ids.push($(element).data('id'));
                });
                console.log(ids);
            }
        });

        const getTaxaList = (url) => {
            $.get(url).then(
                function (response) {
                    let $taxaList = $('#taxa-list');
                    let $pagination = $('.pagination-centered');
                    let paginationNext = $('.pagination-next');
                    let paginationPrev = $('.pagination-previous');

                    // Get current page by parsing the next url
                    let currentPage = 1;
                    let taxaCurrentSize = 0;
                    if (response['next']) {
                        let url = new URL(response['next']);
                        let page = url.searchParams.get('page');
                        currentPage = page - 1;
                        taxaCurrentSize = currentPage * 20;
                    }
                    if (!response['next'] && response['previous']) {
                        let url = new URL(response['previous']);
                        currentPage = parseInt(url.searchParams.get('page')) + 1;
                        taxaCurrentSize = response['count']
                    }
                    $taxaList.html('');
                    $.each(response['results'], function (index, data) {
                        let name = data['canonical_name'];
                        if (!name) {
                            name = data['scientific_name'];
                        }
                        $taxaList.append(`<tr><td>${name}</td><td>${data['rank']}</td><td>${data['taxonomic_status']}</td></tr>`);
                    });
                    if (response['next'] == null && response['previous'] == null) {
                        $pagination.hide();
                    } else {
                        $('#taxa-count').html(response['count']);
                        $('#taxa-current-size').html(taxaCurrentSize);
                        $('#taxa-current-page').html((currentPage * 20) - 19);
                        $pagination.show();
                        if (response['next']) {
                            paginationNext.show();
                            paginationNext.off('click');
                            paginationNext.click(() => {
                                getTaxaList(response['next']);
                            })
                        } else {
                            paginationNext.hide();
                        }
                        if (response['previous']) {
                            paginationPrev.show();
                            paginationPrev.off('click');
                            paginationPrev.click(() => {
                                getTaxaList(response['previous']);
                            })
                        } else {
                            paginationPrev.hide();
                        }
                    }
                }
            )
        }

        $('.ui-state-default').click(function (e) {
            let $elm = $(e.target);
            let maxTry = 10;
            let currentTry = 1;
            while (!$elm.hasClass('ui-state-default') && currentTry < maxTry) {
                currentTry++;
                $elm = $elm.parent();
            }
            $('.ui-state-default').removeClass('selected');
            $elm.addClass('selected');
            let id = $elm.data('id');
            getTaxaList(`/api/taxa-list/?taxonGroup=${id}`);
        })
    </script>
{% endblock %}